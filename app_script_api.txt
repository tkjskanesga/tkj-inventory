/**
 * KONFIGURASI
 * Harap isi dua variabel di bawah ini sebelum melakukan deployment.
 */
const TARGET_FOLDER_ID = "ID Folder Google Drive Anda"; // ID folder tujuan di Google Drive
const SECRET_KEY = "Kode Rahasia"; // Kunci rahasia yang sama dengan di file config.ini.php Anda

/**
 * Fungsi utama yang akan dijalankan saat ada request POST ke URL Web App.
 * Fungsi ini bertugas menerima file, membuat folder backup harian, dan menyimpannya ke Google Drive.
 * @param {object} e - Objek event yang berisi parameter request.
 * @returns {ContentService.TextOutput} - Respons JSON yang berisi status dan URL file.
 */
function doPost(e) {
  // Validasi Keamanan
  if (e.parameter.secret !== SECRET_KEY) {
    return createJsonResponse({
      status: 'error',
      message: 'Akses ditolak: Kunci rahasia tidak valid.'
    });
  }

  // Validasi Parameter
  if (!e.parameter.file || !e.parameter.filename || !e.parameter.mimetype) {
    return createJsonResponse({
      status: 'error',
      message: 'Request tidak lengkap. Parameter file, filename, dan mimetype wajib ada.'
    });
  }

  try {
    const fileData = e.parameter.file;
    const fileName = e.parameter.filename;
    const mimeType = e.parameter.mimetype;

    // Proses File
    const decodedFile = Utilities.base64Decode(fileData, Utilities.Charset.UTF_8);
    const blob = Utilities.newBlob(decodedFile, mimeType, fileName);

    // Interaksi dengan Google Drive
    const targetFolder = DriveApp.getFolderById(TARGET_FOLDER_ID);
    
    // --- MEMBUAT SUBFOLDER BERDASARKAN TANGGAL ---
    const now = new Date();
    // Format tanggal menjadi "dd-MM-yyyy". Menggunakan zona waktu WIB (GMT+7).
    const formattedDate = Utilities.formatDate(now, "GMT+7", "dd-MM-yyyy");
    const subFolderName = "Backup " + formattedDate;
    
    let backupSubFolder;
    
    // Periksa apakah subfolder untuk tanggal hari ini sudah ada.
    const folders = targetFolder.getFoldersByName(subFolderName);
    if (folders.hasNext()) {
      // Jika sudah ada, gunakan folder tersebut.
      backupSubFolder = folders.next();
    } else {
      // Jika belum ada, buat folder baru.
      backupSubFolder = targetFolder.createFolder(subFolderName);
    }

    // Buat file baru di dalam subfolder backup yang sudah ditentukan.
    const newFile = backupSubFolder.createFile(blob);

    // Atur izin file agar bisa diakses oleh siapa saja yang memiliki link.
    newFile.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);

    // Kirim Respons Sukses
    return createJsonResponse({
      status: 'success',
      url: newFile.getUrl()
    });

  } catch (error) {
    // Tangani Error
    console.error("Gagal mengunggah file: " + error.toString());
    return createJsonResponse({
      status: 'error',
      message: 'Terjadi kesalahan internal saat menyimpan file ke Drive: ' + error.toString()
    });
  }
}

/**
 * Fungsi helper untuk membuat respons dalam format JSON.
 * @param {object} data - Objek JavaScript yang akan diubah menjadi JSON.
 * @returns {ContentService.TextOutput} - Objek respons JSON.
 */
function createJsonResponse(data) {
  return ContentService.createTextOutput(JSON.stringify(data))
    .setMimeType(ContentService.MimeType.JSON);
}